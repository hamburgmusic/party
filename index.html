<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake ‚Äì Event Minigame</title>
  <style>
    :root{
      --ui-bg: rgba(0,0,0,.55);
      --ui-text: #fff;
      --accent: #00e0a4;
      --danger: #ff4d4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    body{
      background:#111 url('assets/event-bg.jpg') center/cover no-repeat fixed;
      /* Optional: override background image via URL param: ?bg=https%3A%2F%2F... */
      background-attachment: fixed;
    }
    .backdrop{position:fixed;inset:0;background:radial-gradient(80% 100% at 50% 0%, rgba(0,0,0,.25), rgba(0,0,0,.8))}
    .wrap{position:relative;display:flex;align-items:center;justify-content:center;min-height:100%;padding:16px}

    .hud{position:fixed;top:12px;left:12px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:var(--ui-bg);color:var(--ui-text);padding:8px 12px;border-radius:999px;backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.15)}
    .pill strong{color:var(--accent)}

    .panel{position:fixed;right:12px;top:12px;background:var(--ui-bg);color:var(--ui-text);padding:10px 12px;border-radius:12px;backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.15);max-width:320px}
    .panel summary{cursor:pointer;list-style:none}
    .panel details>summary::-webkit-details-marker{display:none}
    .panel label{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:6px 0;font-size:14px}
    .panel input[type="color"]{width:36px;height:24px;border:none;padding:0;background:transparent}
    .panel input[type="range"]{width:160px}

    .frame{position:relative;display:flex;align-items:center;justify-content:center;width:min(92vmin, 100%);height:min(92vmin, 70vh);margin:auto;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.12);background:rgba(0,0,0,.35);backdrop-filter: blur(6px)}
    canvas{display:block;position:relative;z-index:1;border-radius:12px;background:rgba(8,8,8,.6);width:100%;height:100%} 

    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:2;pointer-events:auto}
.overlay\[hidden\]{display:none !important}  
    .card{background:var(--ui-bg);color:var(--ui-text);padding:20px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,.15);max-width:520px}
    .card h1{margin:0 0 8px;font-size:24px}
    .card p{margin:6px 0 0;opacity:.9}
    .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
    .btn{appearance:none;border:none;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#003a2e}
    .btn.ghost{background:transparent;color:var(--ui-text);border:1px solid rgba(255,255,255,.25)}
    .btn.danger{background:var(--danger);color:white}

    .dpad{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:grid;grid-template-columns:64px 64px 64px;grid-template-rows:64px 64px;gap:8px;opacity:.98}
    .dpad button{background:var(--ui-bg);border:1px solid rgba(255,255,255,.2);color:var(--ui-text);border-radius:16px;font-size:20px;font-weight:700}
    .dpad .up{grid-column:2;grid-row:1}
    .dpad .left{grid-column:1;grid-row:2}
    .dpad .down{grid-column:2;grid-row:2}
    .dpad .right{grid-column:3;grid-row:2}

    @media (min-height: 820px){
      .frame{height:min(92vmin, 78vh)}
    }
    @media (min-width: 900px){
      .dpad{display:none}
    }
  </style>
</head>
<body>
  <div class="backdrop" aria-hidden="true"></div>
  <div class="wrap">
    <div class=\"hud\" aria-live=\"polite\">\n      <div class=\"pill\" id=\"scorePill\">Punkte: <strong>0<\/strong><\/div>\n      <div class=\"pill\" id=\"bestPill\">Best: <strong>0<\/strong><\/div>\n      <div class=\"pill\" id=\"globalPill\">Global: <strong>-<\/strong> <span id=\"globalName\" style=\"opacity:.8\"><\/span><\/div>\n      <div class=\"pill\" id=\"statusPill\">Bereit<\/div>\n    <\/div>
      <div class="pill" id="bestPill">Best: <strong>0</strong></div>
      <div class="pill" id="statusPill">Bereit</div>
    </div>

    <details class="panel" id="settings">
      <summary><strong>‚öôÔ∏è Einstellungen</strong></summary>
      <div style="margin-top:8px">
        <label>Takt / Geschwindigkeit <input id="speed" type="range" min="80" max="240" step="10" value="140"></label>
        <label>Gittergr√∂√üe (Zellen) <input id="grid" type="range" min="12" max="40" step="2" value="22"></label>
        <label>Schlangenfarbe <input id="snakeColor" type="color" value="#00e0a4"></label>
        <label>Food-Farbe <input id="foodColor" type="color" value="#ffd166"></label>
        <label><span>W√§nde sind t√∂dlich</span> <input id="walls" type="checkbox" checked></label>
        <label><span>Hintergrund weichzeichnen</span> <input id="blurBg" type="checkbox" checked></label>
      </div>
    </details>

    <div class="frame">
      <canvas id="game" width="600" height="600" role="img" aria-label="Snake Spielbrett"></canvas>

      <div class="overlay" id="startOverlay">
        <div class="card">
          <h1>üêç Snake ‚Äì Event Edition</h1>
          <p>Steuere die Schlange, iss die Snacks, wachse ‚Äì und kollidiere nicht mit dir selbst <span id="wallsHint">oder den W√§nden</span>.</p>
          <p style="font-size:13px;opacity:.85">Desktop: Pfeiltasten/WASD ¬∑ Leertaste: Pause ¬∑ R: Neustart. Mobil: Wischen oder Tasten unten.</p>
          <div style=\"margin-top:10px\">\n            <label style=\"display:flex;gap:8px;align-items:center;justify-content:center\">\n              <span style=\"min-width:72px;text-align:right\">Name:<\/span>\n              <input id=\"playerNameInput\" type=\"text\" minlength=\"2\" maxlength=\"24\" placeholder=\"z.‚ÄØB. Anna\" style=\"flex:1;max-width:220px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.25);color:#fff\" required>\n            <\/label>\n          <\/div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" id=\"startBtn\">Start<\/button>\n            <button class=\"btn ghost\" id=\"muteBtn\" aria-pressed=\"false\">üîä Sound<\/button>\n          <\/div>
        </div>
      </div>

      <div class="overlay" id="pauseOverlay" hidden>
        <div class="card">
          <h1>‚è∏Ô∏è Pause</h1>
          <p>Weiter mit <b>Leertaste</b> oder Tippen.</p>
          <div class="actions">
            <button class="btn primary" id="resumeBtn">Weiter</button>
            <button class="btn ghost" id="restartBtn">Neu starten</button>
          </div>
        </div>
      </div>

      <div class="overlay" id="gameOverOverlay" hidden>
        <div class="card">
          <h1>üíÄ Game Over</h1>
          <p>Punkte: <b id="finalScore">0</b></p>
          <div class="actions">
            <button class="btn primary" id="againBtn">Nochmal</button>
            <button class="btn ghost" id="shareBtn">Teilen</button>
            <button class="btn danger" id="resetBestBtn">Best l√∂schen</button>
          </div>
        </div>
      </div>
    </div>

    <div class="dpad" aria-label="Touch-Steuerung">
      <button class="up" aria-label="hoch">‚ñ≤</button>
      <button class="left" aria-label="links">‚óÑ</button>
      <button class="down" aria-label="runter">‚ñº</button>
      <button class="right" aria-label="rechts">‚ñ∫</button>
    </div>
  </div>

  <script>
  // ---- Utility: background from ?bg=URL ----
  (function(){
    const params = new URLSearchParams(location.search);
    const bg = params.get('bg');
    if(bg){
      document.body.style.backgroundImage = `url('${decodeURIComponent(bg)}')`;
    }
  })();

  // ---- Minimal sound (no external files) ----
  const Sfx = (() => {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    let muted = false;
    const play = (type='eat') => {
      if(muted) return;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      let f1=440, f2=660, dur=0.08;
      if(type==='eat'){f1=520;f2=740;dur=0.09}
      if(type==='die'){f1=200;f2=110;dur=0.25}
      if(type==='move'){f1=380;f2=420;dur=0.04}
      o.frequency.setValueAtTime(f1, now);
      o.frequency.exponentialRampToValueAtTime(f2, now+dur);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.3, now+dur*0.2);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.start(now);o.stop(now+dur);
    };
    return {play, toggle(){muted=!muted; return !muted}, isMuted:()=>muted};
  })();

  // ---- Game State ----
  const state = {\n    grid: 22,\n    speedMs: 140,\n    snake: [],\n    dir: {x:1,y:0},\n    nextDir: {x:1,y:0},\n    food: null,\n    alive: false,\n    paused: false,\n    score: 0,\n    wallsDeadly: true,\n    colors: {snake:'#00e0a4', food:'#ffd166'},\n    tickTimer: null,\n    playerName: localStorage.getItem('snakePlayerName') || ''\n  };

  // Elements
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const scorePill = document.querySelector('#scorePill strong');\n  const globalPill = document.querySelector('#globalPill strong');\n  const globalNameEl = document.getElementById('globalName');
  const bestPill = document.querySelector('#bestPill strong');
  const statusPill = document.getElementById('statusPill');
  const startOverlay = document.getElementById('startOverlay'); // cache start overlay
  const pauseOverlay = document.getElementById('pauseOverlay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  function hideAllOverlays(){
    startOverlay.setAttribute('hidden',''); startOverlay.style.display='none';
    pauseOverlay.setAttribute('hidden',''); pauseOverlay.style.display='none';
    gameOverOverlay.setAttribute('hidden',''); gameOverOverlay.style.display='none';
  }
  const finalScore = document.getElementById('finalScore');
  const wallsHint = document.getElementById('wallsHint');

  const startBtn = document.getElementById('startBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const restartBtn = document.getElementById('restartBtn');
  const againBtn = document.getElementById('againBtn');
  const shareBtn = document.getElementById('shareBtn');
  const resetBestBtn = document.getElementById('resetBestBtn');
  const muteBtn = document.getElementById('muteBtn');\n  const playerNameInput = document.getElementById('playerNameInput');

  const speed = document.getElementById('speed');
  const grid = document.getElementById('grid');
  const snakeColor = document.getElementById('snakeColor');
  const foodColor = document.getElementById('foodColor');
  const walls = document.getElementById('walls');
  const blurBg = document.getElementById('blurBg');

  // High DPI scaling
  function resizeCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = cvs.getBoundingClientRect();
    cvs.width = Math.round(rect.width * dpr);
    cvs.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }
  window.addEventListener('resize', resizeCanvas);

  function ensurePlayerName(){\n    if(state.playerName && state.playerName.trim().length>=2) return true;\n    startOverlay.hidden=false; startOverlay.style.display='flex';\n    playerNameInput.value = state.playerName || '';\n    playerNameInput.focus();\n    return false;\n  }\n  function reset(){
    const mid = Math.floor(state.grid/2);
    state.snake = [{x:mid-1,y:mid},{x:mid,y:mid}];
    state.dir = {x:1,y:0};
    state.nextDir = {x:1,y:0};
    state.food = randomFreeCell();
    state.score = 0;
    state.alive = true;
    state.paused = false;
    hideAllOverlays();
    startOverlay.style.display = 'none'; startOverlay.hidden = true;
    updateHUD();
    tickLoop();
  }

  function randomFreeCell(){
    const occ = new Set(state.snake.map(p=>p.x+','+p.y));
    let x,y,guard=0;
    do{
      x = Math.floor(Math.random()*state.grid);
      y = Math.floor(Math.random()*state.grid);
      guard++;
      if(guard>10000) break;
    }while(occ.has(x+','+y));
    return {x,y};
  }

  function updateHUD(){
    scorePill.textContent = state.score;
    const best = Number(localStorage.getItem('snakeBest')||0);
    bestPill.textContent = Math.max(best, state.score);
    statusPill.textContent = state.alive ? (state.paused? 'Pause' : 'L√§uft') : 'Bereit';
    wallsHint.style.display = state.wallsDeadly? 'inline' : 'none';
    document.querySelector('.backdrop').style.backdropFilter = blurBg.checked? 'blur(2px)' : 'none';
  }

  function setDirection(nx,ny){
    // Prevent 180¬∞ reversals
    if(state.snake.length>1 && nx===-state.dir.x && ny===-state.dir.y) return;
    state.nextDir = {x:nx, y:ny};
  }

  function tick(){
    if(!state.alive || state.paused) return;
    state.dir = state.nextDir; // apply queued dir at start of tick
    const head = state.snake[state.snake.length-1];
    let nx = head.x + state.dir.x;
    let ny = head.y + state.dir.y;

    if(state.wallsDeadly){
      if(nx<0||ny<0||nx>=state.grid||ny>=state.grid){
        return die();
      }
    } else {
      nx = (nx+state.grid)%state.grid;
      ny = (ny+state.grid)%state.grid;
    }

    // self collision
    for(let i=0;i<state.snake.length;i++){
      const s = state.snake[i];
      if(s.x===nx && s.y===ny){
        return die();
      }
    }

    const newHead = {x:nx,y:ny};
    state.snake.push(newHead);

    // eat?
    if(nx===state.food.x && ny===state.food.y){
      state.score += 1;
      Sfx.play('eat');
      state.food = randomFreeCell();
    } else {
      state.snake.shift();
      // Sfx.play('move'); // uncomment for tick sounds
    }

    updateHUD();
    draw();
  }

  function die(){
    state.alive = false;
    Sfx.play('die');
    const best = Number(localStorage.getItem('snakeBest')||0);
    if(state.score>best){ localStorage.setItem('snakeBest', String(state.score)); }
    finalScore.textContent = state.score;
    hideAllOverlays();
    gameOverOverlay.hidden = false; gameOverOverlay.style.display='flex';
    statusPill.textContent = 'Game Over';
    stopLoop();
  }

  function draw(){
    const w = cvs.clientWidth, h = cvs.clientHeight;
    ctx.clearRect(0,0,w,h);
    const cell = Math.floor(Math.min(w,h)/state.grid);
    const offX = Math.floor((w - cell*state.grid)/2);
    const offY = Math.floor((h - cell*state.grid)/2);

    // grid subtle
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = '#fff';
    for(let y=0;y<state.grid;y++){
      for(let x=0;x<state.grid;x++){
        if((x+y)%2===0){
          ctx.fillRect(offX+x*cell, offY+y*cell, cell, cell);
        }
      }
    }
    ctx.globalAlpha = 1;

    // food
    ctx.fillStyle = state.colors.food;
    const r = Math.floor(cell*0.4);
    const fx = offX + state.food.x*cell + cell/2;
    const fy = offY + state.food.y*cell + cell/2;
    ctx.beginPath(); ctx.arc(fx,fy,r,0,Math.PI*2); ctx.fill();

    // snake
    ctx.fillStyle = state.colors.snake;
    for(const s of state.snake){
      ctx.fillRect(offX + s.x*cell+1, offY + s.y*cell+1, cell-2, cell-2);
    }
  }

  function tickLoop(){
    stopLoop();
    state.tickTimer = setInterval(tick, state.speedMs);
  }
  function stopLoop(){ if(state.tickTimer){ clearInterval(state.tickTimer); state.tickTimer=null; } }

  // Controls: keyboard
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowUp'||e.key==='w') setDirection(0,-1);
    if(e.key==='ArrowDown'||e.key==='s') setDirection(0,1);
    if(e.key==='ArrowLeft'||e.key==='a') setDirection(-1,0);
    if(e.key==='ArrowRight'||e.key==='d') setDirection(1,0);
    if(e.key===' '){
      if(!state.alive){ return; }
      state.paused = !state.paused;
      pauseOverlay.hidden = !state.paused;
      updateHUD();
    }
    if(e.key==='r'){ restart(); }
  });

  // Touch swipe detection
  (function(){
    let sx=0, sy=0, t=0;
    cvs.addEventListener('touchstart', (e)=>{ const p=e.changedTouches[0]; sx=p.clientX; sy=p.clientY; t=Date.now(); });
    cvs.addEventListener('touchend', (e)=>{
      const p=e.changedTouches[0];
      const dx=p.clientX-sx, dy=p.clientY-sy; const dt=Date.now()-t;
      if(dt>500) return; // slow = ignore
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>20) setDirection(1,0); else if(dx<-20) setDirection(-1,0);
      } else {
        if(dy>20) setDirection(0,1); else if(dy<-20) setDirection(0,-1);
      }
    });
  })();

  // D-Pad buttons
  document.querySelector('.dpad .up').onclick = ()=>setDirection(0,-1);
  document.querySelector('.dpad .down').onclick = ()=>setDirection(0,1);
  document.querySelector('.dpad .left').onclick = ()=>setDirection(-1,0);
  document.querySelector('.dpad .right').onclick = ()=>setDirection(1,0);

  // Buttons
  startBtn.onclick = ()=>{\n    const n = (playerNameInput.value||'').trim();\n    if(n.length<2){ playerNameInput.focus(); return; }\n    state.playerName = n;\n    localStorage.setItem('snakePlayerName', n);\n    resumeAudio();\n    reset();\n  };
  resumeBtn.onclick = ()=>{ state.paused=false; hideAllOverlays(); updateHUD(); };
  restartBtn.onclick = ()=> restart();
  againBtn.onclick = ()=> restart();
  shareBtn.onclick = async ()=>{
    const text = `Ich habe ${state.score} Punkte bei SNAKE geschafft! üêç`;
    if(navigator.share){ try{ await navigator.share({text}); } catch{} }
    else { navigator.clipboard.writeText(text); alert('Text in Zwischenablage!'); }
  };
  resetBestBtn.onclick = ()=>{ localStorage.removeItem('snakeBest'); updateHUD(); };
  muteBtn.onclick = ()=>{ const on = !Sfx.isMuted(); const nowOn = !on ? true : !Sfx.toggle(); muteBtn.setAttribute('aria-pressed', String(!Sfx.isMuted())); muteBtn.textContent = Sfx.isMuted()? 'üîá Sound aus' : 'üîä Sound'; };
  function resumeAudio(){
    // Resume context on iOS Safari after user gesture
    try{ if(Sfx && Sfx.play) Sfx.play('move'); }catch{}
  }

  // Settings bindings
  speed.addEventListener('input', ()=>{ state.speedMs = Number(speed.value); if(state.alive) tickLoop(); });
  grid.addEventListener('input', ()=>{ state.grid = Number(grid.value); if(state.alive) reset(); else draw(); });
  snakeColor.addEventListener('input', ()=>{ state.colors.snake = snakeColor.value; draw(); });
  foodColor.addEventListener('input', ()=>{ state.colors.food = foodColor.value; draw(); });
  walls.addEventListener('change', ()=>{ state.wallsDeadly = walls.checked; wallsHint.style.display = state.wallsDeadly? 'inline' : 'none'; });
  blurBg.addEventListener('change', updateHUD);

  function restart(){
    hideAllOverlays();
    reset();
  }

  // Init
  resizeCanvas();
  draw();
  updateHUD();
  // Accessibility: enter starts
  window.addEventListener('keydown', (e)=>{ if(!state.alive && (e.key==='Enter'||e.key===' ')) { resumeAudio(); reset(); } });
  </script>
</body>
</html>
